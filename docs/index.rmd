---
title: 'Lecture 3: Spatial Data Viz'
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(fig.width = 7.5)
knitr::opts_chunk$set(fig.height = 5.5)
knitr::opts_chunk$set(fig.align = 'center')
library(readr)
library(ggmap)
library(dplyr)
library(knitr)
```

## Data Viz Overview

Data visualization is an essential part of the statistical analysis process, both for exploratory analyses and summarizing findings.

##### Exploratory Data Analysis

- Used for data quality checks

- Help explore and understand the data

- Typically, not seen by anyone else

##### Polished Data Visualization

- Used to summarize data in presentations or papers

- Should *stand alone* with appropriate titles, axes, labels, and captions

## Spatial Data Viz Tools

There are many tools for creating spatial figures (GIS software, Tableau, etc...), but we will exclusively use R and the wide range of packages within it.

In particular, we will use:

- `ggplot2`

- `ggmap`

- `leaflet`

- `RgoogleMaps`

- and many others...


## Point Data: What is this?
```{r, fig.align= 'center'}
uber <- read_csv('./uber_coords.csv')
plot(y = uber$Lat, x=uber$Lon, xlab = 'Longitude', ylab = 'Latitude')
```


## Point Data: How about now?
```{r}
api.exist <- try(read_file('./google_api.txt'), silent = T)
if (!inherits(api.exist, "try-error")) {
  mykey <- read_file('./google_api.txt')
  register_google(key = mykey)
  myMap <- get_map(location = c(lon = - 74,lat = 40.75),
                 source = "google",
                 maptype = "roadmap", crop = FALSE,
                 zoom = 11, api_key = mykey)

  ggmap(myMap) + geom_point(aes(x=Lon, y=Lat),  size=.5, data=uber) 
  
} else {
  print('NEED TO SET UP GOOGLE API AND STORE IN .TXT FILE ')
}
```

## Point Data: Is this better?
```{r}
api.exist <- try(read_file('./google_api.txt'), silent = T)
if (!inherits(api.exist, "try-error")) {
  mykey <- read_file('./google_api.txt')
  register_google(key = mykey)
  myMap <- get_map(location = c(lon = - 74,lat = 40.75),
                 source = "google",
                 maptype = "roadmap", crop = FALSE,
                 zoom = 11, api_key = mykey)

  ggmap(myMap) + geom_point(aes(x=Lon, y=Lat), alpha=.03, size=.5, data=uber) + labs(title = 'Location of Uber pickups on May 1, 2014 for NYC Destinations', caption = 'source: https://www.kaggle.com/fivethirtyeight/uber-pickups-in-new-york-city') + xlab('') + ylab('') +
    theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
  
} else {
  print('NEED TO SET UP GOOGLE API AND STORE IN .TXT FILE ')
}
```

## `ggmap` Code Overview
```{r, eval = F, echo = T}
 mykey <- read_file('./google_api.txt')
  register_google(key = mykey)
  myMap <- get_map(location = c(lon = - 74,lat = 40.75),
                 source = "google",
                 maptype = "roadmap", crop = FALSE,
                 zoom = 11, api_key = mykey)

  ggmap(myMap) + 
    geom_point(aes(x=Lon, y=Lat), alpha=.03, size=.5, data=uber) + 
    labs(title = 'Location of Uber pickups on May 1, 2014 for NYC Destinations', 
    caption = 'source: https://www.kaggle.com/fivethirtyeight/uber-pickups-in-new-york-city') + 
    xlab('') + ylab('') +
    theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
```


## Principles for Point Data

1. Include useful background for appropriate context: there are several approaches for acquiring maps in R. Sometimes streets may be more useful, but in other situation a terrain image might be more relevant.
2. With a point patterns, use transparency or heat map summaries to distinguish between areas of higher and lower intensity.
3. Include useful titles, labels, and where appropriate, captions (*all figures*). These figures should stand alone.
4. Sources should be cited in figures.

## Cloning a Repo
Luckily, for all of us, this course will not consist of me talking for 75 minutes. Rather, active learning components will be interspersed within the day. In general, we will spend some time talking about a topic and then I will give you time to work through data visualization or analysis.

To facilitate the active learning sessions, I'd recommend cloning the repo at the start of class. For instance, here is the repo for today [https://github.com/Stat534/Lecture3](https://github.com/Stat534/Lecture3). Using R Studio to create a local project is one way to do this, but you won't have `push` access to my repo.




## Active Learning Exercise: Seattle Police Calls Data Viz
```{r, message = T, echo = T}
seattle <- read_csv('./SeattlePolice.csv')
```

# Cartography

## Distance Calculations

A collaborator suggests that there may a spatial relationship between the police calls in the Seattle Data Set. How would you calculate the distance between those points?

```{r}
seattle %>% slice(1:3) %>% select(Event.Clearance.Description, Longitude, Latitude) %>% kable
```

## Distance Calculations, follow up

A collaborator suggests that there may a spatial relationship between the police calls in the Seattle Data Set. How would you calculate the distance between those points?

```{r}
seattle %>% slice(1:3) %>% select(Event.Clearance.Description, Longitude, Latitude) %>% kable
```

As a follow up:

- what are the units you have calculated?
- are they consistent across latitude?

## Map Projections

```{r, out.width = "600px"}
knitr::include_graphics("./face.png")
```

## Map Projections
Map projections are a representation of a surface on a plane. Specifically, functions are designed to map the geographical coordinate system $(\lambda, \phi)$ to an approach such that:

$$x = f(\lambda, \phi), \; \; y = g(\lambda, \phi),$$

where

## UTM projections

## Distances on the earth's surface

## Distance Metrics

- Euclidean
- geodesic


# Spatial Data in R

## Vector Data

## `sf` package

## Additional Vector Geometries

## Raster Data

## `raster` package

## Map Making with `tmap`

## Additional References
- [Google API for ggmap](https://www.r-bloggers.com/geocoding-with-ggmap-and-the-google-api/)

- [leaflet demo](https://www.rstudio.com/resources/videos/mapping-in-r-with-leaflet/)

- [Geocomputation with R: mapping overview](https://geocompr.robinlovelace.net/adv-map.html)

- [Creating-maps-in-R](https://github.com/Robinlovelace/Creating-maps-in-R/blob/master/README.md)

- [Making Maps with R](http://eriqande.github.io/rep-res-web/lectures/making-maps-with-R.html)